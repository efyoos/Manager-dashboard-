
import React, { useState, useEffect } from 'react';

// Types
enum RequestStatus {
  RECEIVED = 'received',
  SERVED = 'served',
  REJECTED = 'rejected'
}

enum RequestUrgency {
  LOW = 'low',
  MEDIUM = 'medium',
  HIGH = 'high'
}

interface GuestRequest {
  id: string;
  hotel_id: string;
  room_number: string;
  guest_name: string;
  category: string;
  urgency: RequestUrgency;
  status: RequestStatus;
  created_at: string;
}

// Mock data
const mockRequests: GuestRequest[] = [
  {
    id: '550e8400-e29b-41d4-a716-446655440001',
    hotel_id: 'hotel_1',
    room_number: '302',
    guest_name: 'Sarah Johnson',
    category: 'Room Service',
    urgency: RequestUrgency.HIGH,
    status: RequestStatus.RECEIVED,
    created_at: new Date(Date.now() - 10 * 60000).toISOString()
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440002',
    hotel_id: 'hotel_1',
    room_number: '105',
    guest_name: 'Michael Chen',
    category: 'Maintenance',
    urgency: RequestUrgency.MEDIUM,
    status: RequestStatus.RECEIVED,
    created_at: new Date(Date.now() - 45 * 60000).toISOString()
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440003',
    hotel_id: 'hotel_1',
    room_number: '721',
    guest_name: 'Emily Rodriguez',
    category: 'Housekeeping',
    urgency: RequestUrgency.LOW,
    status: RequestStatus.SERVED,
    created_at: new Date(Date.now() - 2 * 60 * 60000).toISOString()
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440004',
    hotel_id: 'hotel_1',
    room_number: '412',
    guest_name: 'David Kim',
    category: 'Concierge',
    urgency: RequestUrgency.HIGH,
    status: RequestStatus.RECEIVED,
    created_at: new Date(Date.now() - 5 * 60000).toISOString()
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440005',
    hotel_id: 'hotel_1',
    room_number: '208',
    guest_name: 'Lisa Thompson',
    category: 'Room Service',
    urgency: RequestUrgency.MEDIUM,
    status: RequestStatus.REJECTED,
    created_at: new Date(Date.now() - 90 * 60000).toISOString()
  }
];

// Utils
const getUrgencyColor = (urgency: RequestUrgency): string => {
  switch (urgency) {
    case RequestUrgency.HIGH:
      return '#ef4444';
    case RequestUrgency.MEDIUM:
      return '#f59e0b';
    case RequestUrgency.LOW:
      return '#10b981';
    default:
      return '#6b7280';
  }
};

const formatDateTime = (dateString: string): string => {
  const date = new Date(dateString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// StatusBadge Component
const StatusBadge: React.FC<{ status: RequestStatus }> = ({ status }) => {
  const statusStyles: Record<RequestStatus, React.CSSProperties> = {
    [RequestStatus.RECEIVED]: {
      backgroundColor: '#dbeafe',
      color: '#1e40af'
    },
    [RequestStatus.SERVED]: {
      backgroundColor: '#dcfce7',
      color: '#166534'
    },
    [RequestStatus.REJECTED]: {
      backgroundColor: '#fee2e2',
      color: '#991b1b'
    }
  };

  return (
    <span
      style={{
        ...statusStyles[status],
        padding: '4px 12px',
        borderRadius: '12px',
        fontSize: '12px',
        fontWeight: 600,
        textTransform: 'capitalize'
      }}
    >
      {status}
    </span>
  );
};

// RequestTable Component
const RequestTable: React.FC<{
  requests: GuestRequest[];
  onSelectRequest: (request: GuestRequest) => void;
  selectedId?: string;
}> = ({ requests, onSelectRequest, selectedId }) => {
  if (requests.length === 0) {
    return (
      <div style={{ textAlign: 'center', padding: '48px', color: '#6b7280' }}>
        No requests found
      </div>
    );
  }

  return (
    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
      <thead>
        <tr style={{ borderBottom: '2px solid #e5e7eb', textAlign: 'left' }}>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Room</th>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Guest</th>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Category</th>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Urgency</th>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Status</th>
          <th style={{ padding: '12px', fontWeight: 600, color: '#374151' }}>Time</th>
        </tr>
      </thead>
      <tbody>
        {requests.map((request) => (
          <tr
            key={request.id}
            onClick={() => onSelectRequest(request)}
            style={{
              borderBottom: '1px solid #e5e7eb',
              cursor: 'pointer',
              backgroundColor: selectedId === request.id ? '#f3f4f6' : 'transparent',
              transition: 'background-color 0.15s'
            }}
            onMouseEnter={(e) => {
              if (selectedId !== request.id) {
                e.currentTarget.style.backgroundColor = '#f9fafb';
              }
            }}
            onMouseLeave={(e) => {
              if (selectedId !== request.id) {
                e.currentTarget.style.backgroundColor = 'transparent';
              }
            }}
          >
            <td style={{ padding: '12px', fontWeight: 500 }}>{request.room_number}</td>
            <td style={{ padding: '12px' }}>{request.guest_name}</td>
            <td style={{ padding: '12px' }}>{request.category}</td>
            <td style={{ padding: '12px' }}>
              <span style={{ display: 'flex', alignItems: 'center' }}>
                <span
                  style={{
                    display: 'inline-block',
                    width: '8px',
                    height: '8px',
                    borderRadius: '50%',
                    backgroundColor: getUrgencyColor(request.urgency),
                    marginRight: '8px'
                  }}
                />
                {request.urgency}
              </span>
            </td>
            <td style={{ padding: '12px' }}>
              <StatusBadge status={request.status} />
            </td>
            <td style={{ padding: '12px', color: '#6b7280', fontSize: '14px' }}>
              {formatDateTime(request.created_at)}
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  );
};

// RequestDetail Component
const RequestDetail: React.FC<{
  request: GuestRequest;
  onUpdateStatus: (status: RequestStatus) => void;
  onClose: () => void;
}> = ({ request, onUpdateStatus, onClose }) => {
  return (
    <div style={{ padding: '24px', height: '100%', overflowY: 'auto' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
        <h2 style={{ margin: 0, fontSize: '20px', fontWeight: 600 }}>Request Details</h2>
        <button
          onClick={onClose}
          style={{
            background: 'none',
            border: 'none',
            fontSize: '24px',
            cursor: 'pointer',
            color: '#6b7280',
            padding: 0,
            lineHeight: 1
          }}
        >
          ×
        </button>
      </div>

      <div style={{ marginBottom: '24px' }}>
        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            REQUEST ID
          </label>
          <div style={{ fontFamily: 'monospace', fontSize: '13px', color: '#374151', wordBreak: 'break-all' }}>
            {request.id}
          </div>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            ROOM NUMBER
          </label>
          <div style={{ fontSize: '16px', fontWeight: 600 }}>{request.room_number}</div>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            GUEST NAME
          </label>
          <div style={{ fontSize: '16px' }}>{request.guest_name}</div>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            CATEGORY
          </label>
          <div style={{ fontSize: '16px' }}>{request.category}</div>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            URGENCY
          </label>
          <div style={{ display: 'flex', alignItems: 'center' }}>
            <span
              style={{
                display: 'inline-block',
                width: '10px',
                height: '10px',
                borderRadius: '50%',
                backgroundColor: getUrgencyColor(request.urgency),
                marginRight: '8px'
              }}
            />
            <span style={{ fontSize: '16px', textTransform: 'capitalize' }}>{request.urgency}</span>
          </div>
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            STATUS
          </label>
          <StatusBadge status={request.status} />
        </div>

        <div style={{ marginBottom: '16px' }}>
          <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '4px', fontWeight: 600 }}>
            CREATED AT
          </label>
          <div style={{ fontSize: '14px', color: '#374151' }}>{formatDateTime(request.created_at)}</div>
        </div>
      </div>

      <div style={{ borderTop: '1px solid #e5e7eb', paddingTop: '24px' }}>
        <label style={{ display: 'block', fontSize: '12px', color: '#6b7280', marginBottom: '12px', fontWeight: 600 }}>
          UPDATE STATUS
        </label>
        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
          {Object.values(RequestStatus).map((status) => (
            <button
              key={status}
              onClick={() => onUpdateStatus(status)}
              disabled={request.status === status}
              style={{
                padding: '10px 18px',
                borderRadius: '6px',
                border: '1px solid #d1d5db',
                backgroundColor: request.status === status ? '#f3f4f6' : '#fff',
                cursor: request.status === status ? 'not-allowed' : 'pointer',
                fontSize: '14px',
                textTransform: 'capitalize',
                opacity: request.status === status ? 0.5 : 1,
                fontWeight: 500,
                transition: 'all 0.15s'
              }}
              onMouseEnter={(e) => {
                if (request.status !== status) {
                  e.currentTarget.style.backgroundColor = '#f9fafb';
                  e.currentTarget.style.borderColor = '#9ca3af';
                }
              }}
              onMouseLeave={(e) => {
                if (request.status !== status) {
                  e.currentTarget.style.backgroundColor = '#fff';
                  e.currentTarget.style.borderColor = '#d1d5db';
                }
              }}
            >
              {status}
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

// Main Dashboard Component
const Dashboard: React.FC = () => {
  const [requests, setRequests] = useState<GuestRequest[]>([]);
  const [selectedRequest, setSelectedRequest] = useState<GuestRequest | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Simulate API call
    setTimeout(() => {
      const sorted = [...mockRequests].sort((a, b) => {
        const urgencyOrder = { high: 1, medium: 2, low: 3 };
        const urgencyDiff = urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
        if (urgencyDiff !== 0) return urgencyDiff;
        return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
      });
      setRequests(sorted);
      setLoading(false);
    }, 800);

    // Simulate real-time update
    const interval = setInterval(() => {
      setRequests(prev => {
        if (prev.length === 0) return prev;
        
        const randomIndex = Math.floor(Math.random() * prev.length);
        const statuses = [RequestStatus.RECEIVED, RequestStatus.SERVED, RequestStatus.REJECTED];
        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
        
        const updated = [...prev];
        updated[randomIndex] = {
          ...updated[randomIndex],
          status: randomStatus
        };
        
        if (selectedRequest?.id === updated[randomIndex].id) {
          setSelectedRequest(updated[randomIndex]);
        }
        
        return updated;
      });
    }, 15000); // Update every 15 seconds

    return () => clearInterval(interval);
  }, [selectedRequest]);

  const handleUpdateStatus = (status: RequestStatus) => {
    if (!selectedRequest) return;

    const updated = {
      ...selectedRequest,
      status
    };

    setRequests(prev =>
      prev.map(req => (req.id === updated.id ? updated : req))
    );
    setSelectedRequest(updated);
  };

  if (loading) {
    return (
      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh', backgroundColor: '#f9fafb' }}>
        <div style={{ textAlign: 'center' }}>
          <div style={{ 
            width: '40px', 
            height: '40px', 
            border: '3px solid #e5e7eb', 
            borderTopColor: '#3b82f6',
            borderRadius: '50%',
            animation: 'spin 1s linear infinite',
            margin: '0 auto 16px'
          }} />
          <div style={{ fontSize: '16px', color: '#6b7280' }}>Loading requests...</div>
        </div>
      </div>
    );
  }

  return (
    <>
      <style>{`
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      `}</style>
      <div style={{ display: 'flex', height: '100vh', fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }}>
        <div style={{ 
          flex: selectedRequest ? '0 0 60%' : '1', 
          overflowY: 'auto', 
          borderRight: '1px solid #e5e7eb',
          transition: 'flex 0.3s'
        }}>
          <div style={{ padding: '24px', borderBottom: '1px solid #e5e7eb', backgroundColor: '#fff', position: 'sticky', top: 0, zIndex: 10 }}>
            <h1 style={{ margin: 0, fontSize: '24px', fontWeight: 600, color: '#111827' }}>Guest Requests</h1>
            <p style={{ margin: '8px 0 0 0', color: '#6b7280', fontSize: '14px' }}>
              {requests.length} total requests • {requests.filter(r => r.status === RequestStatus.RECEIVED).length} pending
            </p>
          </div>
          <RequestTable
            requests={requests}
            onSelectRequest={setSelectedRequest}
            selectedId={selectedRequest?.id}
          />
        </div>

        {selectedRequest && (
          <div style={{ 
            flex: '0 0 40%', 
            backgroundColor: '#f9fafb',
            borderLeft: '1px solid #e5e7eb'
          }}>
            <RequestDetail
              request={selectedRequest}
              onUpdateStatus={handleUpdateStatus}
              onClose={() => setSelectedRequest(null)}
            />
          </div>
        )}
      </div>
    </>
  );
};

export default Dashboard;
